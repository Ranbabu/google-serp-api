<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ImageSearchMan — DDG Proxy</title>
<style>
  /* (Same modern mobile-friendly UI as पहले) */
  :root{--bg:#f8fafc;--card:#fff;--muted:#6b7280;--accent:#0f172a;--outline:#0ea5a4}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:28px}
  .search{margin-top:12px;display:flex;gap:8px}
  .search input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:16px}
  .btn{padding:10px 14px;border-radius:10px;border:2px solid var(--outline);background:transparent;color:var(--outline);font-weight:700;cursor:pointer}
  .btn.solid{background:var(--outline);color:#fff;border:0}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .thumb{background:var(--card);border-radius:8px;overflow:hidden;cursor:pointer;border:1px solid rgba(15,23,42,0.04)}
  .thumb img{width:100%;height:160px;object-fit:cover;display:block}
  @media(max-width:760px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:420px){.grid{grid-template-columns:repeat(1,1fr)}}
  .meta{padding:8px;font-size:13px;color:var(--muted)}
  .footer{margin-top:16px;color:var(--muted);font-size:13px}
  .small{font-size:13px;padding:6px 8px}
  .loader{padding:18px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ImageSearchMan (DDG Proxy)</h1>
    </header>

    <div class="search">
      <input id="q" placeholder="खोजें — जैसे: 'प्रधानमंत्री योजना' " />
      <button id="search" class="btn">Search</button>
      <button id="videos" class="btn small">Open Videos</button>
    </div>

    <div id="history" style="margin-top:10px"></div>

    <div id="loader" class="loader" style="display:none">लोड कर रहे हैं…</div>
    <div id="grid" class="grid"></div>

    <div style="display:flex;justify-content:center;margin-top:12px">
      <button id="more" class="btn" style="display:none">और दिखाओ</button>
    </div>

    <div class="footer">
      नोट: यह proxy DuckDuckGo से images लाने के लिए server-side token use करता है — इसे अपनाने पर CORS error नहीं आएगा।<br/>
      Replace <code>PROXY_URL</code> in script with your render URL.
    </div>
  </div>

<script>
/*
  Replace PROXY_URL with your Render public URL, e.g.:
  const PROXY_URL = 'https://ddg-proxy-server.onrender.com'
*/
const PROXY_URL = 'https://REPLACE_WITH_YOUR_RENDER_URL'; // <-- CHANGE THIS

const qInput = document.getElementById('q');
const searchBtn = document.getElementById('search');
const videosBtn = document.getElementById('videos');
const grid = document.getElementById('grid');
const loader = document.getElementById('loader');
const moreBtn = document.getElementById('more');
const historyWrap = document.getElementById('history');

let currentQ = '';
let offset = 0;
let moreAvailable = false;

function saveHistory(q){
  if(!q) return;
  let arr = JSON.parse(localStorage.getItem('ddg_hist')||'[]');
  arr = arr.filter(x=>x!==q);
  arr.unshift(q);
  if(arr.length>15) arr=arr.slice(0,15);
  localStorage.setItem('ddg_hist', JSON.stringify(arr));
  renderHistory();
}
function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('ddg_hist')||'[]');
  if(arr.length===0){ historyWrap.innerHTML=''; return; }
  historyWrap.innerHTML = '<div style="color:#6b7280;margin-top:8px">History: ' + arr.map(x=>`<button class="btn small" onclick="useHist('${encodeURIComponent(x)}')">${x}</button>`).join(' ') + '</div>';
}
function useHist(enc){ qInput.value = decodeURIComponent(enc); doSearch(); }

async function fetchImages(q, s=0){
  const url = `${PROXY_URL}/api/images?q=${encodeURIComponent(q)}&s=${s}`;
  loader.style.display='block';
  moreBtn.style.display='none';
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Network response not ok: '+res.status);
    const data = await res.json();
    loader.style.display='none';
    return data;
  }catch(err){
    loader.style.display='none';
    console.error(err);
    alert('Server error: ' + (err.message||'Failed to fetch'));
    throw err;
  }
}

function addThumb(item){
  const d = document.createElement('div');
  d.className='thumb';
  const imgUrl = item.image || item.thumbnail || item.src || '';
  d.innerHTML = `<img src="${imgUrl}" loading="lazy" alt="${(item.title||'image')}" />
    <div class="meta">${(item.title||'').slice(0,80)}<div style="margin-top:6px;font-size:12px;color:#9ca3af">Source: ${item.source||item.url||'unknown'}</div></div>`;
  d.addEventListener('click', ()=>{
    // open source in new tab
    window.open(item.url || item.source || imgUrl, '_blank');
  });
  grid.appendChild(d);
}

async function doSearch(){
  const q = qInput.value.trim();
  if(!q) return alert('कृपया खोज शब्द डालें');
  currentQ = q;
  offset = 0;
  grid.innerHTML='';
  saveHistory(q);
  try{
    const data = await fetchImages(q, offset);
    if(!data || !data.results || data.results.length===0){
      grid.innerHTML = '<div style="padding:14px;color:#6b7280">कोई चित्र नहीं मिला</div>';
      return;
    }
    data.results.forEach(addThumb);
    // DuckDuckGo returns "next" sometimes; we allow user to try more
    moreAvailable = !!data.next || data.results.length>=100;
    moreBtn.style.display = moreAvailable ? 'inline-block' : 'none';
  }catch(e){}
}

moreBtn.addEventListener('click', async ()=>{
  offset += 100;
  try{
    const data = await fetchImages(currentQ, offset);
    if(data && data.results && data.results.length>0){
      data.results.forEach(addThumb);
      moreAvailable = !!data.next || data.results.length>=100;
      moreBtn.style.display = moreAvailable ? 'inline-block' : 'none';
    } else {
      moreBtn.style.display='none';
    }
  }catch(e){}
});

searchBtn.addEventListener('click', doSearch);
qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

videosBtn.addEventListener('click', ()=>{
  const q = encodeURIComponent(currentQ || qInput.value.trim());
  if(!q) return alert('पहले खोजें, फिर वीडियो खोलें');
  window.open(`https://duckduckgo.com/?q=${q}&iax=videos&ia=videos`, '_blank');
  window.open(`https://www.youtube.com/results?search_query=${q}`, '_blank');
  window.open(`https://www.bing.com/videos/search?q=${q}`, '_blank');
});

// init
renderHistory();
</script>
</body>
</html>
